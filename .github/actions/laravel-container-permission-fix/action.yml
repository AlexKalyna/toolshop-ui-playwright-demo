name: Laravel Container Permission Fix
description: Fix Laravel permissions by running commands inside the container with proper user context
runs:
  using: "composite"
  steps:
    - name: Container-internal permission fixes
      run: |
        cd practice-software-testing
        echo "ðŸ”§ === LARAVEL CONTAINER PERMISSION FIX ==="
        
        echo "ðŸ” Current container user context:"
        docker-compose exec -T laravel-api whoami || echo "Could not determine user"
        docker-compose exec -T laravel-api id || echo "Could not get user ID"
        
        echo "ðŸ“ Fixing permissions using container's internal context..."
        
        # Method 1: Use container's internal user to fix permissions
        echo "ðŸ—‚ï¸ Setting storage directory permissions (as container user)..."
        docker-compose exec -T --user=root laravel-api chmod -R 777 storage || echo "âš ï¸  Root chmod failed, trying alternative"
        docker-compose exec -T --user=root laravel-api chown -R www-data:www-data storage || echo "âš ï¸  Root chown failed"
        
        # Method 2: Alternative approach using cp to create writable files
        echo "ðŸ“ Creating writable cache files..."
        docker-compose exec -T laravel-api touch storage/logs/laravel.log || echo "âš ï¸  Could not create log file"
        docker-compose exec -T --user=root laravel-api chmod 666 storage/logs/laravel.log || echo "âš ï¸  Could not set log file permissions"
        
        # Method 3: Ensure bootstrap cache is writable
        echo "ðŸ—‚ï¸ Setting bootstrap/cache permissions..."
        docker-compose exec -T --user=root laravel-api chmod -R 777 bootstrap/cache || echo "âš ï¸  Bootstrap cache chmod failed"
        docker-compose exec -T --user=root laravel-api chown -R www-data:www-data bootstrap/cache || echo "âš ï¸  Bootstrap cache chown failed"
        
        # Method 4: Create cache files with proper permissions
        echo "ðŸ“„ Pre-creating cache files..."
        docker-compose exec -T laravel-api touch bootstrap/cache/config.php || echo "â„¹ï¸  Config cache file exists"
        docker-compose exec -T --user=root laravel-api chmod 666 bootstrap/cache/config.php || echo "âš ï¸  Config cache permissions failed"
        
        docker-compose exec -T laravel-api touch bootstrap/cache/routes-v7.php || echo "â„¹ï¸  Routes cache file exists"
        docker-compose exec -T --user=root laravel-api chmod 666 bootstrap/cache/routes-v7.php || echo "âš ï¸  Routes cache permissions failed"
        
        # Verify storage structure
        echo "ðŸ“‹ Verifying storage structure:"
        docker-compose exec -T laravel-api ls -la storage/
        echo "ðŸ“‹ Verifying bootstrap/cache structure:"
        docker-compose exec -T laravel-api ls -la bootstrap/cache/
        
        # Test file writing capability
        echo "ðŸ§ª Testing write capabilities..."
        docker-compose exec -T laravel-api sh -c 'echo "test" > storage/logs/test.log && echo "âœ… Storage write test passed" || echo "âŒ Storage write test failed"'
        docker-compose exec -T laravel-api sh -c 'echo "test" > bootstrap/cache/test.php && echo "âœ… Cache write test passed" || echo "âŒ Cache write test failed"'
        
        # Clean up test files
        docker-compose exec -T laravel-api rm -f storage/logs/test.log bootstrap/cache/test.php || echo "â„¹ï¸  Test cleanup completed"
        
        # Now try Laravel operations with fixed permissions
        echo "ðŸ”„ Attempting Laravel operations with fixed permissions..."
        
        # Clear existing caches first
        docker-compose exec -T laravel-api php artisan config:clear || echo "âš ï¸  Config clear failed"
        docker-compose exec -T laravel-api php artisan route:clear || echo "âš ï¸  Route clear failed"
        
        # Try to regenerate caches
        echo "âš™ï¸ Testing config cache generation..."
        docker-compose exec -T laravel-api php artisan config:cache && echo "âœ… Config cache successful" || echo "âŒ Config cache still failing"
        
        echo "ðŸ›£ï¸ Testing route cache generation..."
        docker-compose exec -T laravel-api php artisan route:cache && echo "âœ… Route cache successful" || echo "âŒ Route cache still failing"
        
        # Final API test
        echo "ðŸŒ Final API endpoint test..."
        sleep 5
        
        # Test the specific endpoint
        if curl -f -s http://localhost:8091/brands >/dev/null 2>&1; then
          echo "âœ… API endpoint working!"
          echo "ðŸ“‹ Sample API response:"
          curl -s http://localhost:8091/brands | head -c 200
        else
          echo "âŒ API endpoint still failing"
          echo "ðŸ” Debugging API response:"
          curl -v http://localhost:8091/brands 2>&1 | head -10
        fi
        
        # Return to original directory if we changed
        echo "ðŸ”§ === LARAVEL CONTAINER PERMISSION FIX COMPLETE ==="
      shell: bash 