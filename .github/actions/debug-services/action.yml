name: Debug Services
description: Comprehensive service debugging for failed startups with Node.js version handling
runs:
  using: "composite"
  steps:
    - name: Comprehensive service debugging
      run: |
        cd practice-software-testing
        echo "ğŸ” === COMPREHENSIVE SERVICE DEBUGGING ==="
        echo "Timestamp: $(date)"
        echo ""
        
        echo "ğŸ“¦ === DOCKER CONTAINER STATUS ==="
        docker ps -a || echo "âŒ Docker ps failed"
        echo ""
        
        echo "ğŸ³ === DOCKER COMPOSE STATUS ==="
        # Remove all checks for 'app' directory, always assume 'practice-software-testing'
        docker-compose ps || echo "âŒ Docker compose ps failed"
        echo ""
        
        echo "ğŸ”Œ === PORT CHECKS ==="
        echo "Checking port 3306 (MariaDB):"
        nc -z localhost 3306 && echo "âœ… Port 3306 open" || echo "âŒ Port 3306 closed"
        
        echo "Checking port 8091 (API):"
        nc -z localhost 8091 && echo "âœ… Port 8091 open" || echo "âŒ Port 8091 closed"
        
        echo "Checking port 4200 (Frontend):"
        nc -z localhost 4200 && echo "âœ… Port 4200 open" || echo "âŒ Port 4200 closed"
        echo ""
        
        echo "ğŸŒ === HTTP CHECKS ==="
        echo "Testing API root:"
        curl -v http://localhost:8091/ 2>&1 || echo "âŒ API root failed"
        echo ""
        
        echo "Testing API brands endpoint:"
        curl -v http://localhost:8091/brands 2>&1 || echo "âŒ API brands failed"
        echo ""
        
        echo "Testing Frontend root:"
        curl -v http://localhost:4200/ 2>&1 || echo "âŒ Frontend root failed"
        echo ""
        
        echo "ğŸ” Enhanced Frontend Diagnostics:"
        echo "Testing with different timeouts and methods..."
        curl -m 10 --connect-timeout 5 http://localhost:4200/ 2>&1 || echo "âŒ Frontend with timeout failed"
        echo ""
        
        echo "Testing Frontend Angular routes:"
        curl -v http://localhost:4200/auth/login 2>&1 || echo "âŒ Frontend login route failed"
        echo ""
        
        echo "Checking if Angular dev server is running in container:"
        docker-compose exec -T angular-ui ps aux | grep -E "(ng|node|angular)" || echo "â„¹ï¸  No Angular processes found"
        echo ""
        
        echo "ğŸ“œ === CONTAINER LOGS (Last 100 lines) ==="
        echo "--- API Container Logs ---"
        docker-compose logs --tail=100 laravel-api || echo "âŒ API logs failed"
        echo ""
        
        echo "--- Frontend Container Logs (CRITICAL - Container Analysis) ---"
        docker-compose logs --tail=100 angular-ui || echo "âŒ Frontend logs failed"
        echo ""
        
        echo "--- Full Frontend Container Logs (All startup logs) ---"
        docker-compose logs angular-ui || echo "âŒ Full frontend logs failed"
        echo ""
        
        echo "--- Database Container Logs ---"
        docker-compose logs --tail=50 mariadb || echo "âŒ Database logs failed"
        echo ""
        
        echo "--- Web Server Container Logs ---"
        docker-compose logs --tail=50 web || echo "âŒ Web server logs failed"
        echo ""
        
        echo "ğŸ’¾ === DISK SPACE ==="
        df -h || echo "âŒ Disk space check failed"
        echo ""
        
        echo "ğŸ§  === MEMORY USAGE ==="
        free -h || echo "âŒ Memory check failed"
        echo ""
        
        echo "ğŸ”— === NETWORK INFO ==="
        netstat -tlnp | grep -E ':(3306|4200|8091)' || echo "âŒ No services listening on expected ports"
        echo ""
        
        echo "ğŸ³ === DOCKER SYSTEM INFO ==="
        docker system df || echo "âŒ Docker system info failed"
        echo ""
        
        echo "ğŸ”§ === ENHANCED CONTAINER TROUBLESHOOTING ==="
        echo "Checking for failed containers..."
        
        # Check if angular-ui container failed
        if docker ps -a | grep angular-ui | grep -q "Exited"; then
          echo "ğŸš¨ Angular UI container has failed - performing enhanced diagnostics..."
          
          echo "ğŸ“‹ Container inspection:"
          docker-compose ps angular-ui || echo "âŒ Status check failed"
          
          echo "ğŸ” Checking Node.js version issue..."
          if docker-compose logs angular-ui 2>/dev/null | grep -q "requires a minimum Node.js version"; then
            echo "âœ… IDENTIFIED: Node.js version compatibility issue detected"
            echo "ğŸ“Š Current Node.js version in container:"
            docker-compose logs angular-ui | grep "Node.js version" || echo "âŒ Could not extract version"
            echo "ğŸ“‹ Required Node.js version:"
            docker-compose logs angular-ui | grep "requires a minimum" || echo "âŒ Could not extract requirement"
            
            echo "ğŸ”§ Attempting to rebuild with updated Node.js..."
            echo "ğŸ’¡ Trying container rebuild to force image update..."
            docker-compose build --no-cache angular-ui || echo "âŒ Build failed"
            
            echo "ğŸš€ Attempting restart with fresh build..."
            docker-compose up -d angular-ui || echo "âŒ Restart failed"
            
            echo "â³ Waiting 60 seconds for Angular startup..."
            sleep 60
            
            echo "ğŸ“Š Container status after rebuild:"
            docker-compose ps angular-ui || echo "âŒ Status check failed"
            
            echo "ğŸ” Latest logs after rebuild:"
            docker-compose logs --tail=50 angular-ui || echo "âŒ Latest logs failed"
            
          else
            echo "â“ Node.js version issue not detected, checking other failure modes..."
            
            echo "ğŸ”„ Attempting standard restart..."
            docker-compose restart angular-ui || echo "âŒ Restart failed"
            sleep 30
            echo "Container status after restart:"
            docker-compose ps angular-ui || echo "âŒ Status check failed"
          fi
          
          echo "ğŸŒ Final port accessibility check:"
          sleep 10
          nc -z localhost 4200 && echo "âœ… Port 4200 is now accessible" || echo "âŒ Port 4200 still not accessible"
          
        else
          echo "â„¹ï¸  Angular UI container status appears normal"
          docker-compose ps angular-ui || echo "âŒ Status check failed"
        fi
        
        echo "ğŸ”§ === DOCKER COMPOSE TROUBLESHOOTING ==="
        echo "ğŸ“‹ Docker Compose file validation:"
        docker-compose config --quiet && echo "âœ… docker-compose.yml is valid" || echo "âŒ docker-compose.yml has issues"
        
        echo "ğŸ” === DEBUGGING COMPLETE ==="
      shell: bash 